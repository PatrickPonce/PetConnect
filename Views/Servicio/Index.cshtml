@using X.PagedList
@using X.PagedList.Mvc.Core
@model IPagedList<PetConnect.ViewModels.ServicioViewModel>

@{
    ViewData["Title"] = "Veterinarias";
}

<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />

<!-- INICIO: Estilos adaptados de la vista de Lugares -->
<style>
    .vet-container { padding: 2rem 1rem; text-align: center; }
    .page-title { font-size: 2.5rem; font-weight: bold; color: #fd8ba9; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1); }
    .search-bar-container { display: flex; justify-content: center; margin: 2rem 0; }
    .search-form { display: flex; width: 100%; max-width: 500px; }
    .search-input { flex-grow: 1; padding: 0.8rem; border: 1px solid #ddd; border-radius: 8px 0 0 8px; }
    .search-button { padding: 0.8rem 1.2rem; border: none; background-color: #d67a7a; color: white; border-radius: 0 8px 8px 0; cursor: pointer; }
    
    .vet-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 2rem;
        margin-top: 2rem;
        max-width: 1100px;
        margin-left: auto;
        margin-right: auto;
    }

    .vet-card { position: relative; background-color: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); width: 100%; overflow: hidden; display: flex; flex-direction: column; }
    .vet-imagen { width: 100%; height: 220px; object-fit: cover; }
    .vet-contenido { padding: 1.5rem; text-align: left; flex-grow: 1; }
    .vet-nombre { font-size: 1.5rem; font-weight: 600; color: #333; }
    .btn-ver-mas { display: block; margin-top: 1rem; padding: 0.75rem; background-color: #d67a7a; color: white; text-align: center; text-decoration: none; border-radius: 8px; }
    
    .favorito-btn { position: absolute; top: 15px; right: 15px; background-color: rgba(255, 255, 255, 0.9); border-radius: 50%; width: 45px; height: 45px; display: flex; justify-content: center; align-items: center; cursor: pointer; border: none; backdrop-filter: blur(5px); }
    .favorito-btn .material-symbols-outlined { color: #a8798e; font-variation-settings: 'FILL' 0; transition: all 0.2s; font-size: 28px; }
    .favorito-btn.activo .material-symbols-outlined { color: #e25e83; font-variation-settings: 'FILL' 1; }

    .pagination-container { margin-top: 3rem; display: flex; justify-content: center; align-items: center; gap: 0.5rem; list-style: none; padding: 0; }
    .page-item .page-link { padding: 0.6rem 1rem; border: 1px solid #ddd; text-decoration: none; color: #d67a7a; background-color: #fff; border-radius: 5px; }
    .page-item.active .page-link { background-color: #d67a7a; color: white; border-color: #d67a7a; }
    .page-item.disabled .page-link { color: #ccc; border-color: #eee; pointer-events: none; }

    .modal-alerta { /* ... estilos del modal ... */ }

    @@media (max-width: 992px) { .vet-grid { grid-template-columns: repeat(2, 1fr); } }
    @@media (max-width: 768px) { .vet-grid { grid-template-columns: 1fr; } }
</style>
<!-- FIN: Estilos -->

<div class="vet-container">
    <h1 class="page-title">Encuentra la mejor atención para tu mascota</h1>
    
    <div class="search-bar-container">
        <form asp-controller="Servicio" asp-action="Index" method="get" class="search-form">
            <input type="text" name="busqueda" placeholder="Buscar veterinaria por nombre..." class="search-input" value="@ViewData["BusquedaActual"]" />
            <button type="submit" class="search-button">Buscar</button>
        </form>
    </div>

    <div class="vet-grid">
        @foreach (var item in Model)
        {
            <div class="vet-card">
                <img src="@(item.Servicio.ImagenPrincipalUrl ?? "/images/placeholder.png")" alt="Imagen de @item.Servicio.Nombre" class="vet-imagen" />
                <button class="favorito-btn @(item.EsFavorito ? "activo" : "")" data-id="@item.Servicio.Id" title="Añadir a favoritos">
                    <span class="material-symbols-outlined">favorite</span>
                </button>
                <div class="vet-contenido">
                    <h3 class="vet-nombre">@item.Servicio.Nombre</h3>
                    <p>@item.Servicio.VeterinariaDetalle?.Direccion?.Split(',').FirstOrDefault()</p>
                    <a asp-controller="Servicio" asp-action="Detalle" asp-route-id="@item.Servicio.Id" class="btn-ver-mas">
                        Ver más detalles
                    </a>
                </div>
            </div>
        }
    </div>

    <!-- Paginación -->
    <div class="pagination-container">
        @Html.PagedListPager(Model, page => Url.Action("Index", new { page, busqueda = ViewData["BusquedaActual"] }),
            new PagedListRenderOptions
            {
                LiElementClasses = new[] { "page-item" },
                PageClasses = new[] { "page-link" },
                UlElementClasses = new[] { "pagination", "justify-content-center" }
            })
    </div>
</div>

<!-- Modal para forzar inicio de sesión -->
<div id="modal-alerta" class="modal-alerta" style="display:none;">
    <div class="modal-alerta-contenido">
        <span class="modal-alerta-cerrar" style="cursor:pointer; position:absolute; top:10px; right:15px; font-size:24px;">&times;</span>
        <h3>Acceso Requerido</h3>
        <p>Debes iniciar sesión para guardar veterinarias en tus favoritos.</p>
        <a href="/Identity/Account/Login" class="btn-ver-mas" style="background-color:#72626e;">Iniciar Sesión</a>
    </div>
</div>

@Html.AntiForgeryToken()

@section Scripts {
<script>
document.addEventListener('DOMContentLoaded', function() {
    const usuarioHaIniciadoSesion = @(User.Identity.IsAuthenticated ? "true" : "false");
    const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
    const modal = document.getElementById('modal-alerta');
    
    document.querySelectorAll('.favorito-btn').forEach(btn => {
        btn.addEventListener('click', async function(event) {
            event.preventDefault();

            if (!usuarioHaIniciadoSesion) {
                if(modal) modal.style.display = 'flex';
                return;
            }
            
            const servicioId = parseInt(this.dataset.id, 10);
            
            try {
                const response = await fetch('/Servicio/ToggleFavorito', {
                    method: 'POST',
                    headers: {
                        // --- CAMBIO 1: El Content-Type ahora es de formulario ---
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'RequestVerificationToken': token
                    },
                    // --- CAMBIO 2: El body ahora es un string de formulario ---
                    body: `servicioId=${servicioId}`
                });

                if (!response.ok) {
                    // Si el servidor responde con un error, lo mostramos
                    const errorResult = await response.json();
                    throw new Error(errorResult.message || `Error HTTP: ${response.status}`);
                }

                const result = await response.json();
                if (result.success) {
                    this.classList.toggle('activo', result.agregado);
                } else {
                    alert('Hubo un error al procesar tu solicitud.');
                }
            } catch (error) {
                console.error('Error en la solicitud de favoritos:', error);
                alert('Error de conexión. Por favor, intenta de nuevo.');
            }
        });
    });

    if (modal) {
        const cerrarBtn = modal.querySelector('.modal-alerta-cerrar');
        if (cerrarBtn) cerrarBtn.addEventListener('click', () => modal.style.display = 'none');
        window.addEventListener('click', (event) => { if (event.target == modal) modal.style.display = 'none'; });
    }
});
</script>
}