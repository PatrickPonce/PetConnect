@using System.Security.Claims
@model PetConnect.Models.Guarderia
@inject GoogleMapsConfig GoogleMapsConfig

@{
    ViewData["Title"] = Model.Nombre;
    var currentUserId = User.FindFirstValue(ClaimTypes.NameIdentifier);
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />

<style>
    body { background-color: #FFFDEC; }
    .detalle-container { max-width: 1200px; margin: 2rem auto; padding: 1rem; display: flex; flex-wrap: wrap; gap: 2.5rem; }
    .main-content { flex: 3; min-width: 300px; background-color: #FAF6F0; padding: 2rem; border-radius: 8px; }
    .contact-sidebar { flex: 1; background-color: #ffffff; padding: 1.5rem; border-radius: 12px; height: fit-content; border: 1px solid #eee; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    .header { display: flex; align-items: center; gap: 1.5rem; margin-bottom: 1.5rem; }
    .logo { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 4px solid #fff; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .title-info h1 { margin: 0; font-size: 2.5rem; color: #333; }
    .title-info p { margin: 0.2rem 0; color: #555; font-size: 1rem; }
    .rating-stars .fa-star { color: #ffc107; }
    .rating-stars .fa-star.empty { color: #e0e0e0; }
    .banner-container { margin: 1.5rem 0; }
    .banner-image { width: 100%; border-radius: 8px; }
    .tabs-wrapper { margin-top: 2rem; }
    .tabs-container { border-bottom: 1px solid #ddd; margin-bottom: 1.5rem; display: flex; flex-wrap: wrap; }
    .tab-button { padding: 0.8rem 1rem; border: none; background: none; cursor: pointer; font-size: 0.9rem; margin-right: 1rem; border-bottom: 3px solid transparent; color: #555; display: flex; align-items: center; gap: 8px; }
    .tab-button.active { border-bottom-color: #d67a7a; font-weight: bold; color: #333; }
    .tab-content { display: none; padding: 1rem 0; }
    .tab-content.active { display: block; }
    .tab-content h3 { font-size: 1.5rem; margin-top: 0; }
    .contact-sidebar h3 { border-bottom: 2px solid #d67a7a; padding-bottom: 0.5rem; margin-bottom: 1rem; }
    .contact-sidebar ul { list-style: none; padding: 0; }
    .contact-sidebar li { margin-bottom: 1rem; display: flex; align-items: center; }
    .contact-sidebar li i { margin-right: 10px; width: 20px; text-align: center; color: #d67a7a; }
    .contact-sidebar a { text-decoration: none; color: #333; }
    .btn-contactar { display: block; width: 100%; padding: 1rem; background-color: #d17a7a; color: white; text-align: center; text-decoration: none; border-radius: 8px; margin-top: 1.5rem; font-weight: bold; cursor: pointer; border: none; font-size: 1rem; }
    .comentario { position: relative; background-color: #fefefe; border-left: 4px solid #72626e; border-radius: 8px; padding: 1.2rem; margin-bottom: 1.5rem; }
    .comentario-autor { font-weight: bold; color: #555; }
    .comentario-texto { color: #333; }
    .comentario-fecha { font-size: 0.8rem; color: #aaa; text-align: right; margin-top: 0.5rem; }
    .btn-eliminar-comentario { position: absolute; top: 10px; right: 10px; background: none; border: none; color: #e57373; cursor: pointer; font-size: 1rem; opacity: 0.5; transition: opacity 0.2s; }
    .comentario:hover .btn-eliminar-comentario { opacity: 1; }
    .form-comentario textarea { width: 100%; height: 80px; padding: 0.75rem; border-radius: 8px; border: 1px solid #ccc; }
    .form-comentario button { margin-top: 1rem; padding: 0.5rem 1rem; background-color: #72626e; color: white; border: none; border-radius: 8px; cursor: pointer; }
    
    #citaModal.modal-overlay { z-index: 2000; }
    #citaModal .modal-content { background-color: #FFFDEC; max-width: 500px; text-align: left; }
    #citaModal .modal-close-btn { position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; color: #888; cursor: pointer; }
    #citaModal .form-group { margin-bottom: 1rem; }
    #citaModal label { display: block; margin-bottom: .5rem; font-weight: bold; color: #555; }
    #citaModal .form-control { width: 100%; padding: .75rem; border-radius: 8px; border: 1px solid #ccc; }
    #citaModal button[type="submit"] { width: 100%; padding: 1rem; background-color: #28a745; color: white; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; }
    
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 1999; }
    .modal-content { background-color: #FFFDEC; padding: 2.5rem; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); text-align: center; position: relative; max-width: 400px; width: 90%; }
    .close-button { position: absolute; top: 10px; right: 15px; font-size: 1.8rem; font-weight: 300; cursor: pointer; color: #888; }
    .modal-body h3 { color: #333; font-size: 1.8rem; margin: 0 0 1rem 0; font-weight: 600; }
    .modal-body p { font-size: 1rem; margin-bottom: 2rem; color: #555; }
    .modal-login-button { display: block; width: 100%; padding: 1rem; background-color: #e57373; color: white; text-decoration: none; border: none; border-radius: 50px; font-weight: bold; font-size: 1rem; margin-bottom: 1rem; }
    .modal-register-link { color: #6a1b9a; text-decoration: underline; font-weight: 500; }
</style>

<div class="detalle-container">
    <main class="main-content">
        <header class="header">
            @if (!string.IsNullOrEmpty(Model.UrlLogo))
            { <img src="@Model.UrlLogo" alt="Logo de @Model.Nombre" class="logo" /> }
            <div class="title-info">
                <h1>@Model.Nombre</h1>
                <p><i class="fas fa-map-marker-alt"></i> @Model.DireccionCompleta</p>
                <div class="rating-stars">
                    @for (int i = 1; i <= 5; i++)
                    {
                        if (i <= Model.Calificacion) { <i class="fas fa-star"></i> }
                        else if (i - 0.5 <= Model.Calificacion) { <i class="fas fa-star-half-alt"></i> }
                        else { <i class="fas fa-star empty"></i> }
                    }
                </div>
            </div>
        </header>

        <div class="banner-container">
            <img src="~/images/nyacat.png" alt="Banner" class="banner-image" />
        </div>

        <div class="tabs-wrapper">
            <div class="tabs-container">
                <button class="tab-button active" data-tab="descripcion"><i class="fas fa-paw"></i> Descripci贸n</button>
                <button class="tab-button" data-tab="comentarios"><i class="fas fa-comments"></i> Comentarios</button>
                <button class="tab-button" data-tab="galeria"><i class="fas fa-images"></i> Galer铆a</button>
                <button class="tab-button" data-tab="ubicacion"><i class="fas fa-map-marked-alt"></i> Ubicaci贸n</button>
            </div>

            <div id="descripcion" class="tab-content active">
                <h3>@Model.Nombre</h3>
                <p>@Html.Raw(Model.Descripcion)</p>
            </div>

            <div id="comentarios" class="tab-content">
                <section class="comentarios-container">
                    <h3>Opiniones de la comunidad</h3>
                    <div id="lista-comentarios">
                        @if (Model.Comentarios != null && Model.Comentarios.Any())
                        {
                            @foreach (var comentario in Model.Comentarios.OrderByDescending(c => c.FechaComentario))
                            {
                                <div class="comentario" id="comentario-@comentario.Id">
                                    @if (comentario.UsuarioId == currentUserId)
                                    {
                                        <button class="btn-eliminar-comentario" data-id="@comentario.Id" title="Eliminar mi comentario"><i class="fas fa-trash-alt"></i></button>
                                    }
                                    <p class="comentario-autor">@(comentario.Usuario?.UserName ?? "An贸nimo")</p>
                                    <p class="comentario-texto">@comentario.Texto</p>
                                    <p class="comentario-fecha">@comentario.FechaComentario.ToString("g")</p>
                                </div>
                            }
                        }
                        else { <p id="sin-comentarios-msg">A煤n no hay comentarios. 隆S茅 el primero!</p> }
                    </div>
                    <div class="form-comentario">
                        <label for="textoComentario">Deja tu comentario</label>
                        <textarea id="textoComentario" name="textoComentario" required placeholder="Escribe tu opini贸n aqu铆..."></textarea>
                        <button id="comentar-btn" type="button">Comentar</button>
                    </div>
                </section>
            </div>

            <div id="galeria" class="tab-content"> <p>Galer铆a de im谩genes pr贸ximamente...</p> </div>
            <div id="ubicacion" class="tab-content"> <div id="map" style="height: 450px; width: 100%; border-radius: 8px;"></div> </div>
        </div>
    </main>

    <aside class="contact-sidebar">
        <h3>Contacto</h3>
        <ul>
            @if (!string.IsNullOrEmpty(Model.Telefono))
            { <li><i class="fab fa-whatsapp"></i> <a href="https://wa.me/@Model.Telefono.Replace(" ", "")" target="_blank">@Model.Telefono</a></li> }
            @if (!string.IsNullOrEmpty(Model.UrlFacebook))
            { <li><i class="fab fa-facebook"></i> <a href="@Model.UrlFacebook" target="_blank">Facebook</a></li> }
            @if (!string.IsNullOrEmpty(Model.UrlInstagram))
            { <li><i class="fab fa-instagram"></i> <a href="@Model.UrlInstagram" target="_blank">Instagram</a></li> }
            <li><i class="fas fa-map-marker-alt"></i> @Model.DireccionCompleta</li>
            <li><i class="fas fa-location-arrow"></i> @Model.Ubicacion</li>
        </ul>
        <button id="agendarCitaBtn" class="btn-contactar" 
            data-guarderia-id="@Model.Id" 
            data-guarderia-nombre="@Model.Nombre">
            Agendar Cita 
        </button>
    </aside>
</div>

<!-- Modales -->
<div id="login-modal" class="modal-overlay">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <div class="modal-body">
            <h3>Acceso Requerido</h3>
            <p>隆Hola! Debes iniciar sesi贸n o registrarte para poder comentar.</p>
            <a href="/Identity/Account/Login" class="modal-login-button">Iniciar Sesi贸n</a>
            <a href="/Identity/Account/Register" class="modal-register-link">Registrarse</a>
        </div>
    </div>
</div>

<div id="citaModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <span class="modal-close-btn">&times;</span>
        <h3>Agendar Cita en <span id="modalGuarderiaNombre"></span></h3>
        <p>Completa tus datos para solicitar una cita.</p>
        <form id="citaForm" novalidate>
            <input type="hidden" id="modalGuarderiaId" name="GuarderiaId" />
            <div class="form-group">
                <label for="nombre">Tu Nombre:</label>
                <input type="text" id="nombre" name="NombreCliente" class="form-control" required />
            </div>
            <div class="form-group">
                <label for="email">Tu Email:</label>
                <input type="email" id="email" name="EmailCliente" class="form-control" required />
            </div>
            <div class="form-row" style="display: flex; gap: 1rem;">
                <div class="form-group" style="flex: 1;">
                    <label for="fecha">Fecha Deseada:</label>
                    <input type="date" id="fecha" name="Fecha" class="form-control" required />
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="hora">Hora:</label>
                    <select id="hora" name="Hora" class="form-control" required>
                        <option value="" disabled selected>Selecciona...</option>
                        <option value="08:00">08:00 AM</option>
                        <option value="09:00">09:00 AM</option>
                        <option value="10:00">10:00 AM</option>
                        <option value="11:00">11:00 AM</option>
                        <option value="12:00">12:00 PM</option>
                        <option value="14:00">02:00 PM</option>
                        <option value="15:00">03:00 PM</option>
                        <option value="16:00">04:00 PM</option>
                        <option value="17:00">05:00 PM</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="mensaje">Mensaje (opcional):</label>
                <textarea id="mensaje" name="Mensaje" class="form-control" rows="2"></textarea>
            </div>
            <button type="submit" class="btn btn-success">Enviar Solicitud</button>
        </form>
        <div id="modal-feedback" style="display: none; margin-top: 15px;"></div>
    </div>
</div>

@Html.AntiForgeryToken()

<!-- === INICIO DE LA SECCIN DE SCRIPTS CORREGIDA === -->
<script src="https://maps.googleapis.com/maps/api/js?key=@GoogleMapsConfig.ApiKey&callback=initMap" async defer></script>

<script>
    // 隆IMPORTANTE! Esta funci贸n DEBE estar en el alcance global para que Google Maps la encuentre.
    function initMap() {
        // Aseguramos que los decimales usen punto, sin importar la configuraci贸n regional
        const lat = parseFloat("@Model.Latitud.ToString().Replace(",", ".")");
        const lng = parseFloat("@Model.Longitud.ToString().Replace(",", ".")");

        if (isNaN(lat) || isNaN(lng) || (lat === 0 && lng === 0)) {
            const mapDiv = document.getElementById("map");
            if (mapDiv) mapDiv.innerHTML = "<p>Ubicaci贸n no disponible.</p>";
            return;
        }

        const guarderiaPosicion = { lat: lat, lng: lng };
        const map = new google.maps.Map(document.getElementById("map"), {
            zoom: 16,
            center: guarderiaPosicion,
        });
        const marker = new google.maps.Marker({
            position: guarderiaPosicion,
            map: map,
            title: "@Model.Nombre",
        });
    }
</script>

@section Scripts {
<script>
    // Todo el c贸digo que manipula el DOM debe estar dentro de este evento.
    document.addEventListener('DOMContentLoaded', function () {

        // --- FUNCIN HELPER PARA LA FECHA ---
        function setMinDate() {
            const fechaInput = document.getElementById('fecha');
            if (fechaInput) {
                const today = new Date();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const dd = String(today.getDate()).padStart(2, '0');
                fechaInput.min = `${yyyy}-${mm}-${dd}`;
            }
        }

        // --- CONSTANTES Y VARIABLES GENERALES ---
        const usuarioHaIniciadoSesion = @(User.Identity.IsAuthenticated ? "true" : "false");
        const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

        // --- LGICA DE PESTAAS (TABS) ---
        const tabs = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
            });
        });

        // --- LGICA DE COMENTARIOS Y MODAL DE LOGIN ---
        const loginModal = document.getElementById('login-modal');
        const comentarBtn = document.getElementById('comentar-btn');
        if (comentarBtn) {
            comentarBtn.addEventListener('click', async function() {
                if (!usuarioHaIniciadoSesion) {
                    if (loginModal) loginModal.style.display = 'flex';
                    return;
                }
                const textoInput = document.getElementById('textoComentario');
                const texto = textoInput.value;
                if (!texto.trim()) { alert('Por favor, escribe un comentario.'); return; }
                const response = await fetch('/Guarderias/AgregarComentario', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'RequestVerificationToken': token },
                    body: `guarderiaId=@Model.Id&textoComentario=${encodeURIComponent(texto)}`
                });
                if (response.ok) { location.reload(); } else { alert('Error al agregar comentario.'); }
            });
        }
        
        document.querySelectorAll('.btn-eliminar-comentario').forEach(btn => {
            btn.addEventListener('click', async function() {
                if (confirm('驴Est谩s seguro?')) {
                    const comentarioId = this.dataset.id;
                    const response = await fetch('/Guarderias/EliminarComentario', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'RequestVerificationToken': token },
                        body: `comentarioId=${comentarioId}`
                    });
                    if (response.ok) { document.getElementById(`comentario-${comentarioId}`).remove(); }
                    else { alert('No se pudo eliminar el comentario.'); }
                }
            });
        });

        if (loginModal) {
            loginModal.querySelector('.close-button')?.addEventListener('click', () => loginModal.style.display = 'none');
            window.addEventListener('click', (event) => { if (event.target === loginModal) { loginModal.style.display = 'none'; } });
        }
        
        // --- LGICA PARA EL MODAL DE AGENDAR CITA ---
        const citaModal = document.getElementById('citaModal');
        const agendarCitaBtn = document.getElementById('agendarCitaBtn');
        const citaCloseBtn = citaModal.querySelector('.modal-close-btn');
        const citaForm = document.getElementById('citaForm');

        if (agendarCitaBtn) {
            agendarCitaBtn.addEventListener('click', function () {
                setMinDate(); // Establecemos la fecha m铆nima al abrir
                const guarderiaId = this.dataset.guarderiaId;
                const guarderiaNombre = this.dataset.guarderiaNombre;
                citaModal.querySelector('#modalGuarderiaId').value = guarderiaId;
                citaModal.querySelector('#modalGuarderiaNombre').textContent = guarderiaNombre;
                citaModal.style.display = 'flex';
            });
        }

        const closeCitaModal = function() {
            citaModal.style.display = 'none';
            citaForm.reset();
            citaModal.querySelector('#modal-feedback').style.display = 'none';
        }

        if (citaCloseBtn) citaCloseBtn.addEventListener('click', closeCitaModal);
        
        citaModal.addEventListener('click', function(event) {
            if (event.target === citaModal) {
                closeCitaModal();
            }
        });

        citaForm.addEventListener('submit', async function (event) {
            event.preventDefault();
            const feedbackDiv = citaModal.querySelector('#modal-feedback');
            try {
                const response = await fetch('@Url.Action("EnviarSolicitudCita", "Guarderias")', {
                    method: 'POST',
                    body: new FormData(citaForm),
                    headers: { 'RequestVerificationToken': token }
                });
                const result = await response.json();
                feedbackDiv.style.display = 'block';
                if (response.ok && result.success) {
                    feedbackDiv.className = 'alert alert-success';
                    feedbackDiv.textContent = result.message;
                    setTimeout(closeCitaModal, 3500);
                } else {
                    feedbackDiv.className = 'alert alert-danger';
                    feedbackDiv.textContent = result.message || 'Hubo un problema al enviar tu solicitud.';
                }
            } catch (error) {
                feedbackDiv.style.display = 'block';
                feedbackDiv.className = 'alert alert-danger';
                feedbackDiv.textContent = 'Error de conexi贸n. Int茅ntalo de nuevo.';
            }
        });
    });
</script>
}