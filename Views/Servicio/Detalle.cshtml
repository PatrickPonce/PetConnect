@using System.Security.Claims
@model PetConnect.Models.Servicio
@{
    ViewData["Title"] = Model.Nombre;
    var detalles = Model.VeterinariaDetalle;
    var currentUserId = User.FindFirstValue(ClaimTypes.NameIdentifier);
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />

<style>
    body { background-color: #FFFDEC; }
    .detalle-container { max-width: 1200px; margin: 2rem auto; padding: 1rem; display: flex; flex-wrap: wrap; gap: 2.5rem; }
    .main-content { flex: 3; min-width: 300px; background-color: #FAF6F0; padding: 2rem; border-radius: 8px; }
    .contact-sidebar { flex: 1; background-color: #ffffff; padding: 1.5rem; border-radius: 12px; height: fit-content; border: 1px solid #eee; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    .header { display: flex; align-items: center; gap: 1.5rem; margin-bottom: 1.5rem; }
    .logo { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 4px solid #fff; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .title-info h1 { margin: 0; font-size: 2.5rem; color: #333; }
    .title-info p { margin: 0.2rem 0; color: #555; font-size: 1rem; }
    .tabs-wrapper { margin-top: 2rem; }
    .tabs-container { border-bottom: 1px solid #ddd; margin-bottom: 1.5rem; display: flex; flex-wrap: wrap; }
    .tab-button { padding: 0.8rem 1rem; border: none; background: none; cursor: pointer; font-size: 0.9rem; margin-right: 1rem; border-bottom: 3px solid transparent; color: #555; display: flex; align-items: center; gap: 8px; }
    .tab-button.active { border-bottom-color: #d67a7a; font-weight: bold; color: #333; }
    .tab-content { display: none; padding: 1rem 0; }
    .tab-content.active { display: block; }
    .contact-sidebar h3 { border-bottom: 2px solid #d67a7a; padding-bottom: 0.5rem; margin-bottom: 1rem; }
    .contact-sidebar ul { list-style: none; padding: 0; }
    .contact-sidebar li { margin-bottom: 1rem; display: flex; align-items: center; }
    .contact-sidebar li i { margin-right: 10px; width: 20px; text-align: center; color: #d67a7a; }
    .btn-reservar { display: block; width: 100%; padding: 1rem; background-color: #d17a7a; color: white; text-align: center; text-decoration: none; border-radius: 8px; margin-top: 1.5rem; font-weight: bold; cursor: pointer; border: none; font-size: 1rem; }
    .comentario { position: relative; background-color: #fefefe; border-left: 4px solid #72626e; border-radius: 8px; padding: 1.2rem; margin-bottom: 1.5rem; }
    .comentario-autor { font-weight: bold; color: #555; }
    .comentario-texto { color: #333; }
    .comentario-fecha { font-size: 0.8rem; color: #aaa; text-align: right; margin-top: 0.5rem; }
    .btn-eliminar-comentario { position: absolute; top: 10px; right: 10px; background: none; border: none; color: #e57373; cursor: pointer; font-size: 1rem; opacity: 0.5; transition: opacity 0.2s; }
    .comentario:hover .btn-eliminar-comentario { opacity: 1; }
    .form-comentario textarea { width: 100%; height: 80px; padding: 0.75rem; border-radius: 8px; border: 1px solid #ccc; }
    .form-comentario button { margin-top: 1rem; padding: 0.5rem 1rem; background-color: #72626e; color: white; border: none; border-radius: 8px; cursor: pointer; }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 1999; }
    .modal-content { background-color: #FFFDEC; padding: 2.5rem; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); text-align: center; position: relative; max-width: 400px; width: 90%; }
    .close-button { position: absolute; top: 10px; right: 15px; font-size: 1.8rem; font-weight: 300; cursor: pointer; color: #888; }
</style>

<div class="detalle-container">
    <main class="main-content">
        <header class="header">
            @if (!string.IsNullOrEmpty(Model.ImagenPrincipalUrl))
            { <img src="@Model.ImagenPrincipalUrl" alt="Logo de @Model.Nombre" class="logo" /> }
            <div class="title-info">
                <h1>@Model.Nombre</h1>
                <p><i class="fas fa-map-marker-alt"></i> @detalles?.Direccion</p>
            </div>
        </header>

        <div class="tabs-wrapper">
            <div class="tabs-container">
                <button class="tab-button active" data-tab="descripcion"><i class="fas fa-paw"></i> Descripción</button>
                <button class="tab-button" data-tab="comentarios"><i class="fas fa-comments"></i> Comentarios</button>
            </div>

            <div id="descripcion" class="tab-content active">
                <h3>Sobre @Model.Nombre</h3>
                <p>@Html.Raw(detalles?.DescripcionLarga)</p>
            </div>

            <div id="comentarios" class="tab-content">
                <h3>Opiniones de la comunidad</h3>
                <div id="lista-comentarios">
                    @if (Model.Comentarios != null && Model.Comentarios.Any())
                    {
                        @foreach (var comentario in Model.Comentarios.OrderByDescending(c => c.FechaComentario))
                        {
                            <div class="comentario" id="comentario-@comentario.Id">
                                @if (comentario.UsuarioId == currentUserId)
                                {
                                    <button class="btn-eliminar-comentario" data-id="@comentario.Id" title="Eliminar"><i class="fas fa-trash-alt"></i></button>
                                }
                                <p class="comentario-autor">@(comentario.Usuario?.UserName ?? "Anónimo")</p>
                                <p class="comentario-texto">@comentario.Texto</p>
                                <p class="comentario-fecha">@comentario.FechaComentario.ToLocalTime().ToString("g")</p>
                            </div>
                        }
                    }
                    else { <p id="sin-comentarios-msg">Aún no hay comentarios. ¡Sé el primero!</p> }
                </div>
                <div class="form-comentario">
                    <textarea id="textoComentario" placeholder="Escribe tu opinión aquí..." required></textarea>
                    <button id="comentar-btn" type="button">Comentar</button>
                </div>
            </div>
        </div>
    </main>

    <aside class="contact-sidebar">
        <h3>Reservar Cita</h3>
        <p>Asegura tu espacio para una consulta. El pago es solo una simulación.</p>
        <form asp-action="CrearSesionDePago" asp-route-id="@Model.Id" method="post">
            @Html.AntiForgeryToken()
            <button type="submit" class="btn-reservar">Reservar Ahora</button>
        </form>

        <h3 style="margin-top: 2rem;">Contacto</h3>
        <ul>
            <li><i class="fas fa-phone"></i> @detalles?.Telefono</li>
            <li><i class="fas fa-clock"></i> @detalles?.Horario</li>
            <li><i class="fas fa-map-marker-alt"></i> @detalles?.Direccion</li>
        </ul>
    </aside>
</div>

<div id="login-modal" class="modal-overlay">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h3>Acceso Requerido</h3>
        <p>Debes iniciar sesión para poder comentar.</p>
        <a href="/Identity/Account/Login" class="btn-reservar" style="text-decoration:none;">Iniciar Sesión</a>
    </div>
</div>

@Html.AntiForgeryToken()

@section Scripts {
<script>
document.addEventListener('DOMContentLoaded', function () {
    const usuarioHaIniciadoSesion = @(User.Identity.IsAuthenticated ? "true" : "false");
    const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

    // Lógica de Pestañas
    document.querySelectorAll('.tab-button').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelector('.tab-button.active').classList.remove('active');
            document.querySelector('.tab-content.active').classList.remove('active');
            tab.classList.add('active');
            document.getElementById(tab.dataset.tab).classList.add('active');
        });
    });

    // Lógica de Comentarios
    const loginModal = document.getElementById('login-modal');
    const comentarBtn = document.getElementById('comentar-btn');
    if (comentarBtn) {
        comentarBtn.addEventListener('click', async function() {
            if (!usuarioHaIniciadoSesion) {
                if(loginModal) loginModal.style.display = 'flex';
                return;
            }
            const textoInput = document.getElementById('textoComentario');
            const texto = textoInput.value;
            if (!texto.trim()) { alert('El comentario no puede estar vacío.'); return; }
            
            const response = await fetch('/Servicio/AgregarComentario', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'RequestVerificationToken': token },
                body: `servicioId=@Model.Id&textoComentario=${encodeURIComponent(texto)}`
            });
            if (response.ok) { location.reload(); } 
            else { alert('Error al agregar el comentario.'); }
        });
    }
    
    document.querySelectorAll('.btn-eliminar-comentario').forEach(btn => {
        btn.addEventListener('click', async function() {
            if (confirm('¿Estás seguro de que quieres eliminar este comentario?')) {
                const comentarioId = this.dataset.id;
                const response = await fetch('/Servicio/EliminarComentario', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'RequestVerificationToken': token },
                    body: `comentarioId=${comentarioId}`
                });
                if (response.ok) { 
                    document.getElementById(`comentario-${comentarioId}`).remove();
                } else { 
                    alert('No se pudo eliminar el comentario.'); 
                }
            }
        });
    });

    if (loginModal) {
        loginModal.querySelector('.close-button')?.addEventListener('click', () => loginModal.style.display = 'none');
        window.addEventListener('click', (event) => { if (event.target === loginModal) { loginModal.style.display = 'none'; } });
    }
});
</script>
}