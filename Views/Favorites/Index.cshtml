@model PetConnect.ViewModels.FavoritosViewModel
@using Microsoft.AspNetCore.Identity
@inject SignInManager<IdentityUser> SignInManager

@{
    ViewData["Title"] = "Mis Favoritos";
    
    // Calculamos los totales para las "badges" de las pestañas
    int countNoticias = Model.NoticiasFavoritas.Count;
    int countProductos = Model.ProductosFavoritos.Count;
    int countServicios = Model.ServiciosFavoritos.Count;
    int countLugares = Model.LugaresFavoritos.Count + Model.GuarderiasFavoritas.Count; // Agrupamos Lugares y Guarderías
    int totalGeneral = countNoticias + countProductos + countServicios + countLugares;
}

<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />

<style>
    body { background-color: #fdfaf1; }

    /* --- HEADER --- */
    .fav-header {
        text-align: center;
        padding: 3rem 1rem;
        background: linear-gradient(135deg, #97a992 0%, #859f7e 100%);
        color: white;
        border-radius: 0 0 30px 30px;
        margin-bottom: 3rem;
        box-shadow: 0 10px 30px rgba(151, 169, 146, 0.3);
    }
    .fav-title { font-family: 'Fredoka', sans-serif; font-size: 3rem; margin: 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); }
    .fav-subtitle { font-size: 1.1rem; opacity: 0.9; margin-top: 0.5rem; }

    /* --- SEARCH BAR --- */
    .fav-search-wrapper {
        max-width: 600px;
        margin: -5rem auto 3rem auto; /* Superposición sobre el header */
        padding: 0 1rem;
        position: relative;
        z-index: 10;
    }
    .fav-search-box {
        background: white;
        display: flex;
        align-items: center;
        padding: 10px 20px;
        border-radius: 50px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        border: 1px solid #eee;
    }
    .fav-search-input {
        border: none;
        flex-grow: 1;
        padding: 10px;
        font-size: 1.1rem;
        outline: none;
    }
    .fav-search-btn {
        background-color: #E88989;
        color: white;
        border: none;
        width: 40px; height: 40px;
        border-radius: 50%;
        cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        transition: transform 0.2s;
    }
    .fav-search-btn:hover { transform: scale(1.1); }

    /* --- TABS NAVIGATION --- */
    .fav-tabs-container {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 2.5rem;
        padding: 0 1rem;
    }
    .fav-tab {
        background: white;
        border: 2px solid #eee;
        padding: 12px 25px;
        border-radius: 30px;
        cursor: pointer;
        font-weight: 600;
        color: #555;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
        font-size: 1rem;
    }
    .fav-tab:hover {
        border-color: #E88989;
        color: #E88989;
        transform: translateY(-2px);
    }
    .fav-tab.active {
        background-color: #E88989;
        color: white;
        border-color: #E88989;
        box-shadow: 0 5px 15px rgba(232, 137, 137, 0.3);
    }
    .fav-badge {
        background-color: #eee;
        color: #555;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.8rem;
        font-weight: 700;
    }
    .fav-tab.active .fav-badge {
        background-color: rgba(255,255,255,0.3);
        color: white;
    }

    /* --- CONTENT GRIDS --- */
    .fav-panel {
        display: none; /* Ocultos por defecto */
        animation: fadeIn 0.4s ease;
    }
    .fav-panel.active {
        display: block;
    }
    @@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .fav-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 2rem;
        padding: 0 1rem;
        max-width: 1200px;
        margin: 0 auto;
    }

    /* --- CARD STYLES (Generic for favorites) --- */
    .fav-card {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        transition: transform 0.3s, box-shadow 0.3s;
        position: relative;
        border: 1px solid #f0f0f0;
    }
    .fav-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    .fav-card-img {
        width: 100%;
        height: 180px;
        object-fit: cover;
    }
    .fav-card-body {
        padding: 1.5rem;
    }
    .fav-card-title {
        font-weight: 700;
        font-size: 1.2rem;
        margin-bottom: 0.5rem;
        color: #333;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    .fav-card-meta {
        color: #777;
        font-size: 0.9rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    /* Botón Corazón (Para eliminar) */
    .btn-remove-fav {
        position: absolute;
        top: 15px;
        right: 15px;
        background: white;
        border-radius: 50%;
        width: 40px; height: 40px;
        display: flex; align-items: center; justify-content: center;
        border: none;
        cursor: pointer;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        transition: all 0.2s;
        color: #E88989;
    }
    .btn-remove-fav:hover {
        transform: scale(1.1);
        background-color: #E88989;
        color: white;
    }
    .btn-remove-fav .material-symbols-rounded {
        font-variation-settings: 'FILL' 1; /* Corazón lleno */
    }

    /* Estado vacío */
    .empty-state {
        text-align: center;
        padding: 4rem 1rem;
        color: #999;
    }
    .empty-state-icon { font-size: 4rem; margin-bottom: 1rem; color: #ddd; }
</style>

<div class="fav-header">
    <h1 class="fav-title">Mis Favoritos</h1>
    <p class="fav-subtitle">Todo lo que te encanta de Purr & Paws, guardado para ti.</p>
</div>

<div class="fav-search-wrapper">
    <form asp-action="Index" method="get" class="fav-search-box">
        <input type="text" name="searchString" class="fav-search-input" placeholder="Buscar en tus favoritos..." value="@ViewData["CurrentFilter"]">
        <button type="submit" class="fav-search-btn">
            <span class="material-symbols-rounded">search</span>
        </button>
    </form>
</div>

@if (totalGeneral == 0 && string.IsNullOrEmpty(ViewData["CurrentFilter"] as string))
{
    <div class="empty-state">
        <span class="material-symbols-rounded empty-state-icon">favorite_border</span>
        <h3>Aún no tienes favoritos</h3>
        <p>Explora noticias, productos y servicios y dale al corazón para guardarlos aquí.</p>
        <a href="/" class="btn btn-primary mt-3" style="border-radius: 50px; padding: 10px 25px;">Explorar Ahora</a>
    </div>
}
else
{
    <div class="fav-tabs-container">
        <div class="fav-tab active" onclick="showTab('noticias', this)">
            <span class="material-symbols-rounded">newspaper</span>
            Noticias <span class="fav-badge">@countNoticias</span>
        </div>
        <div class="fav-tab" onclick="showTab('productos', this)">
            <span class="material-symbols-rounded">shopping_bag</span>
            Tienda <span class="fav-badge">@countProductos</span>
        </div>
        <div class="fav-tab" onclick="showTab('servicios', this)">
            <span class="material-symbols-rounded">medical_services</span>
            Veterinarias <span class="fav-badge">@countServicios</span>
        </div>
        <div class="fav-tab" onclick="showTab('lugares', this)">
            <span class="material-symbols-rounded">park</span>
            Lugares & Guarderías <span class="fav-badge">@countLugares</span>
        </div>
    </div>

    <div id="panel-noticias" class="fav-panel active">
        <div class="fav-grid">
            @foreach (var item in Model.NoticiasFavoritas)
            {
                <div class="fav-card" id="card-noticia-@item.Id">
                    <img src="@item.UrlImagen" alt="@item.Titulo" class="fav-card-img" />
                    <button class="btn-remove-fav" onclick="eliminarFavorito('noticia', @item.Id, this)">
                        <span class="material-symbols-rounded">favorite</span>
                    </button>
                    <div class="fav-card-body">
                        <div class="fav-card-meta">
                            <span class="material-symbols-rounded" style="font-size:1rem">calendar_today</span>
                            @item.FechaPublicacion.ToString("dd MMM yyyy")
                        </div>
                        <h3 class="fav-card-title">@item.Titulo</h3>
                        <a href="@Url.Action("Detalle", "Noticias", new { id = item.Id })" class="btn btn-sm btn-outline-secondary rounded-pill mt-2">Leer nota</a>
                    </div>
                </div>
            }
            @if (countNoticias == 0) { <p class="text-center text-muted">No tienes noticias guardadas.</p> }
        </div>
    </div>

    <div id="panel-productos" class="fav-panel">
        <div class="fav-grid">
            @foreach (var item in Model.ProductosFavoritos)
            {
                <div class="fav-card" id="card-producto-@item.Id">
                    <img src="@item.UrlImagen" alt="@item.Nombre" class="fav-card-img" onerror="this.src='/images/placeholder.png'" />
                    <button class="btn-remove-fav" onclick="eliminarFavorito('producto', @item.Id, this)">
                        <span class="material-symbols-rounded">favorite</span>
                    </button>
                    <div class="fav-card-body">
                        <h3 class="fav-card-title">@item.Nombre</h3>
                        <p style="color: #E88989; font-weight:bold; font-size: 1.1rem;">S/. @item.Precio.ToString("0.00")</p>
                        <a href="@Url.Action("Detalle", "PetShop", new { id = item.Id })" class="btn btn-sm btn-outline-secondary rounded-pill mt-2">Ver producto</a>
                    </div>
                </div>
            }
            @if (countProductos == 0) { <p class="text-center text-muted">No tienes productos guardados.</p> }
        </div>
    </div>

    <div id="panel-servicios" class="fav-panel">
        <div class="fav-grid">
            @foreach (var item in Model.ServiciosFavoritos)
            {
                <div class="fav-card" id="card-servicio-@item.Id">
                    <img src="@item.ImagenPrincipalUrl" alt="@item.Nombre" class="fav-card-img" onerror="this.src='/images/placeholder.png'" />
                    <button class="btn-remove-fav" onclick="eliminarFavorito('servicio', @item.Id, this)">
                        <span class="material-symbols-rounded">favorite</span>
                    </button>
                    <div class="fav-card-body">
                        <h3 class="fav-card-title">@item.Nombre</h3>
                        <div class="fav-card-meta">
                            <span class="material-symbols-rounded" style="font-size:1rem">location_on</span>
                            @(item.VeterinariaDetalle?.Direccion ?? "Dirección no disponible")
                        </div>
                        <a href="@Url.Action("Detalle", "Servicio", new { id = item.Id })" class="btn btn-sm btn-outline-secondary rounded-pill mt-2">Ver clínica</a>
                    </div>
                </div>
            }
            @if (countServicios == 0) { <p class="text-center text-muted">No tienes veterinarias guardadas.</p> }
        </div>
    </div>

    <div id="panel-lugares" class="fav-panel">
        <div class="fav-grid">
            @foreach (var item in Model.LugaresFavoritos)
            {
                <div class="fav-card" id="card-lugar-@item.Id">
                    <img src="@item.UrlImagenPrincipal" alt="@item.Nombre" class="fav-card-img" onerror="this.src='/images/placeholder.png'" />
                    <button class="btn-remove-fav" onclick="eliminarFavorito('lugar', @item.Id, this)">
                        <span class="material-symbols-rounded">favorite</span>
                    </button>
                    <div class="fav-card-body">
                        <div class="badge bg-success mb-2" style="opacity:0.8">Pet Friendly</div>
                        <h3 class="fav-card-title">@item.Nombre</h3>
                        <div class="fav-card-meta">@item.Ubicacion</div>
                        <a href="@Url.Action("Detalle", "Lugares", new { id = item.Id })" class="btn btn-sm btn-outline-secondary rounded-pill mt-2">Ver lugar</a>
                    </div>
                </div>
            }
            @foreach (var item in Model.GuarderiasFavoritas)
            {
                <div class="fav-card" id="card-guarderia-@item.Id">
                    <img src="@item.UrlImagenPrincipal" alt="@item.Nombre" class="fav-card-img" onerror="this.src='/images/placeholder.png'" />
                    <button class="btn-remove-fav" onclick="eliminarFavorito('guarderia', @item.Id, this)">
                        <span class="material-symbols-rounded">favorite</span>
                    </button>
                    <div class="fav-card-body">
                        <div class="badge bg-warning text-dark mb-2" style="opacity:0.8">Guardería</div>
                        <h3 class="fav-card-title">@item.Nombre</h3>
                        <div class="fav-card-meta">@item.Ubicacion</div>
                        <a href="@Url.Action("Detalle", "Guarderias", new { id = item.Id })" class="btn btn-sm btn-outline-secondary rounded-pill mt-2">Ver guardería</a>
                    </div>
                </div>
            }
            @if (countLugares == 0) { <p class="text-center text-muted">No tienes lugares ni guarderías guardadas.</p> }
        </div>
    </div>
}

<div id="modal-confirmar-eliminar" style="display:none; position:fixed; z-index:2000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center;">
    <div style="background:white; padding:2rem; border-radius:15px; text-align:center; max-width:400px; width:90%; box-shadow:0 10px 30px rgba(0,0,0,0.2);">
        <span class="material-symbols-rounded" style="font-size:3rem; color:#E88989; margin-bottom:1rem">heart_broken</span>
        <h3>¿Quitar de favoritos?</h3>
        <p>¿Estás seguro de que quieres eliminar este elemento de tu lista?</p>
        <div style="margin-top:1.5rem; display:flex; gap:1rem; justify-content:center;">
            <button id="btn-cancelar-borrado" class="btn btn-light rounded-pill px-4">Cancelar</button>
            <button id="btn-confirmar-borrado" class="btn btn-danger rounded-pill px-4" style="background-color:#E88989; border:none;">Sí, quitar</button>
        </div>
    </div>
</div>

@Html.AntiForgeryToken()

@section Scripts {
    <script>
        // Lógica para cambiar de Pestañas
        function showTab(tabName, element) {
            // 1. Ocultar todos los paneles
            document.querySelectorAll('.fav-panel').forEach(p => p.classList.remove('active'));
            
            // 2. Desactivar todos los botones
            document.querySelectorAll('.fav-tab').forEach(t => t.classList.remove('active'));

            // 3. Activar el panel seleccionado
            document.getElementById('panel-' + tabName).classList.add('active');
            
            // 4. Activar el botón seleccionado
            element.classList.add('active');
        }

        // Lógica para eliminar favoritos (AJAX)
        let itemToDelete = null; // { type: string, id: number, element: HTMLElement }
        const modalConfirm = document.getElementById('modal-confirmar-eliminar');
        const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

        function eliminarFavorito(tipo, id, btnElement) {
            itemToDelete = { type: tipo, id: id, element: btnElement };
            modalConfirm.style.display = 'flex';
        }

        document.getElementById('btn-cancelar-borrado').addEventListener('click', () => {
            modalConfirm.style.display = 'none';
            itemToDelete = null;
        });

        document.getElementById('btn-confirmar-borrado').addEventListener('click', async () => {
            if (!itemToDelete) return;

            const { type, id, element } = itemToDelete;
            let url = '';
            let bodyData = {};

            // Mapear tipos a URLs de controladores
            if (type === 'noticia') {
                url = '/Noticias/ToggleFavorito';
                bodyData = { noticiaId: id }; // Noticias usa JSON
            } else if (type === 'producto') {
                url = '/PetShop/ToggleFavorito';
                bodyData = `productoId=${id}`; // PetShop usa FormUrlEncoded
            } else if (type === 'lugar') {
                url = '/Lugares/ToggleFavorito';
                bodyData = { lugarId: id };
            } else if (type === 'guarderia') {
                url = '/Guarderias/ToggleFavorito';
                bodyData = { guarderiaId: id };
            } else if (type === 'servicio') {
                url = '/Servicio/ToggleFavorito';
                bodyData = { servicioId: id };
            }

            // Configurar fetch según el tipo (JSON vs Form)
            const headers = { 'RequestVerificationToken': token };
            let body = '';

            if (type === 'producto' || type === 'servicio') { // Controladores viejos que esperan Form
                 headers['Content-Type'] = 'application/x-www-form-urlencoded';
                 // Si es JSON para servicio (ToggleServicioRequest), ajuste aquí:
                 if(type === 'servicio') {
                     headers['Content-Type'] = 'application/json';
                     body = JSON.stringify(bodyData);
                 } else {
                     body = bodyData;
                 }
            } else {
                headers['Content-Type'] = 'application/json';
                body = JSON.stringify(bodyData);
            }

            try {
                const response = await fetch(url, { method: 'POST', headers: headers, body: body });
                if (response.ok) {
                    // Eliminar la tarjeta con una animación suave
                    const card = element.closest('.fav-card');
                    card.style.transform = 'scale(0.9)';
                    card.style.opacity = '0';
                    setTimeout(() => {
                        card.remove();
                        // Opcional: Actualizar el contador de la pestaña
                    }, 300);
                } else {
                    alert('Error al eliminar el favorito.');
                }
            } catch (error) {
                console.error(error);
            } finally {
                modalConfirm.style.display = 'none';
            }
        });
    </script>
}