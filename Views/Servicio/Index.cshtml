@using X.PagedList
@using X.PagedList.Mvc.Core
@model IPagedList<PetConnect.ViewModels.ServicioViewModel>

@{
    ViewData["Title"] = "Veterinarias";
}

<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />

<!-- Estilos unificados (igual que en Lugares) -->
<style>
    .vet-container { padding: 2rem 1rem; text-align: center; }
    .page-title { font-size: 2.5rem; font-weight: bold; color: #fd8ba9; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1); }
    .search-bar-container { display: flex; justify-content: center; margin: 2rem 0; }
    .search-form { display: flex; width: 100%; max-width: 500px; }
    .search-input { flex-grow: 1; padding: 0.8rem; border: 1px solid #ddd; border-radius: 8px 0 0 8px; }
    .search-button { padding: 0.8rem 1.2rem; border: none; background-color: #d67a7a; color: white; border-radius: 0 8px 8px 0; cursor: pointer; }
    .vet-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2rem; max-width: 1100px; margin: 2rem auto 0 auto; }
    .vet-card { position: relative; background-color: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); overflow: hidden; }
    .vet-imagen { width: 100%; height: 220px; object-fit: cover; }
    .vet-contenido { padding: 1.5rem; text-align: left; }
    .vet-nombre { font-size: 1.5rem; font-weight: 600; color: #333; }
    .btn-ver-mas { display: block; margin-top: 1rem; padding: 0.75rem; background-color: #d67a7a; color: white; text-align: center; text-decoration: none; border-radius: 8px; }
    .favorito-btn { position: absolute; top: 15px; right: 15px; background-color: #ffffff; border-radius: 50%; width: 45px; height: 45px; display: flex; justify-content: center; align-items: center; cursor: pointer; border: none; }
    .favorito-btn .material-symbols-outlined { color: #a8798e; font-variation-settings: 'FILL' 0; transition: all 0.2s; }
    .favorito-btn.activo .material-symbols-outlined { color: #e25e83; font-variation-settings: 'FILL' 1; }
    .pagination-container { margin-top: 3rem; }
    .modal-alerta { position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: center; }
    .modal-alerta-contenido { background-color: #fff; padding: 2.5rem; border-radius: 12px; text-align: center; position: relative; max-width: 450px; width: 90%; }
    .modal-alerta-cerrar { position: absolute; top: 15px; right: 20px; color: #aaa; font-size: 1.8rem; cursor: pointer; }
    .modal-alerta-contenido h3 { color: #d67a7a; font-size: 1.5rem; margin-bottom: 1.5rem; }
    .login-button-group { display: flex; justify-content: center; gap: 15px; }
    .login-button, .register-link { display: inline-block; padding: 1rem 2rem; border-radius: 8px; font-weight: bold; text-decoration: none; border: 2px solid #72626e; }
    .login-button { background-color: #72626e; color: white; }
    .register-link { background-color: transparent; color: #72626e; }
    @@media (max-width: 992px) { .vet-grid { grid-template-columns: repeat(2, 1fr); } }
    @@media (max-width: 768px) { .vet-grid { grid-template-columns: 1fr; } }
</style>

<div class="vet-container">
    <h1 class="page-title">Encuentra la mejor atención para tu mascota</h1>
    
    <div class="search-bar-container">
        <form asp-controller="Servicio" asp-action="Index" method="get" class="search-form">
            <input type="text" name="busqueda" placeholder="Buscar veterinaria por nombre..." class="search-input" value="@ViewData["BusquedaActual"]" />
            <button type="submit" class="search-button">Buscar</button>
        </form>
    </div>

    <div class="vet-grid">
        @foreach (var item in Model)
        {
            <div class="vet-card">
                <img src="@(item.Servicio.ImagenPrincipalUrl ?? "/images/placeholder.png")" alt="Imagen de @item.Servicio.Nombre" class="vet-imagen" />
                <div class="favorito-btn @(item.EsFavorito ? "activo" : "")" data-id="@item.Servicio.Id" title="Añadir a favoritos">
                    <span class="material-symbols-outlined">favorite</span>
                </div>
                <div class="vet-contenido">
                    <h3 class="vet-nombre">@item.Servicio.Nombre</h3>
                    <p>@item.Servicio.VeterinariaDetalle?.Direccion?.Split(',').FirstOrDefault()</p>
                    <a asp-controller="Servicio" asp-action="Detalle" asp-route-id="@item.Servicio.Id" class="btn-ver-mas">
                        Ver más detalles
                    </a>
                </div>
            </div>
        }
    </div>

    <div class="pagination-container">
        @Html.PagedListPager(Model, page => Url.Action("Index", new { page, busqueda = ViewData["BusquedaActual"] }),
            new PagedListRenderOptions
            {
                LiElementClasses = new[] { "page-item" },
                PageClasses = new[] { "page-link" },
                UlElementClasses = new[] { "pagination", "justify-content-center" }
            })
    </div>
</div>

<!-- ESTE ES EL MODAL CORRECTO, IGUAL AL DE LUGARES -->
<div id="modal-alerta" class="modal-alerta">
    <div class="modal-alerta-contenido">
        <span class="modal-alerta-cerrar">&times;</span>
        <h3>Acceso Requerido</h3>
        <p>¡Hola! Debes iniciar sesión o registrarte para guardar veterinarias en tus favoritos.</p>
        <div class="login-button-group">
            <a href="/Identity/Account/Login" class="login-button">Iniciar Sesión</a>
            <a href="/Identity/Account/Register" class="register-link">Registrarse</a>
        </div>
    </div>
</div>

@Html.AntiForgeryToken()

@section Scripts {
<script>
document.addEventListener('DOMContentLoaded', function() {
    const botonesFavoritos = document.querySelectorAll('.favorito-btn');
    const modal = document.getElementById('modal-alerta');
    const cerrarBtn = modal.querySelector('.modal-alerta-cerrar');
    const usuarioHaIniciadoSesion = @(User.Identity.IsAuthenticated ? "true" : "false");
    const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

    botonesFavoritos.forEach(btn => {
        btn.addEventListener('click', async function() {
            if (!usuarioHaIniciadoSesion) {
                modal.style.display = 'flex';
                return;
            }

            const servicioId = parseInt(this.dataset.id, 10);
            
            try {
                // ESTE ES EL SCRIPT CORRECTO, QUE ENVÍA JSON
                const response = await fetch('/Servicio/ToggleFavorito', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': token
                    },
                    body: JSON.stringify({ servicioId: servicioId }) 
                });

                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }

                const result = await response.json();
                if (result.success) {
                    this.classList.toggle('activo', result.agregado); 
                } else {
                    alert('Hubo un error al procesar tu solicitud.');
                }
            } catch (error) {
                console.error('Error en la solicitud de favoritos:', error);
                alert('Error de conexión. Revisa la consola (F12).');
            }
        });
    });

    if (cerrarBtn) {
        cerrarBtn.addEventListener('click', () => modal.style.display = 'none');
    }
    
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    }
});
</script>
}