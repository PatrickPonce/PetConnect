@model List<PetConnect.ViewModels.ProductoViewModel>
@using Microsoft.AspNetCore.Identity
@inject SignInManager<IdentityUser> SignInManager
@{
    ViewData["Title"] = "Pet Shop";
    var tiposProducto = ViewData["TiposProducto"] as List<string> ?? new List<string>();
    var busquedaActual = ViewData["BusquedaActual"] as string;
    var tipoActual = ViewData["TipoActual"] as string;
    // Normalizamos la marca actual para evitar problemas de mayúsculas/espacios
    string marcaActual = (ViewData["MarcaActual"] as string)?.Trim();
}

<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />

<style>
    /* --- ESTILOS DE LAYOUT --- */
    body { background-color: #fdfaf1; font-family: 'Poppins', sans-serif; }
    .petshop-category-page {
        max-width: 1200px; margin: 2rem auto; display: flex; gap: 2rem;
        background-color: white; border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.08); overflow: hidden;
    }
    .petshop-sidebar {
        flex: 0 0 280px; background-color: #fdfaf1; padding: 1.5rem 0;
        border-right: 1px solid #eee;
    }
    .petshop-main-content { flex: 1; padding: 2.5rem 2rem; min-width: 0; }

    /* --- ENLACES DE BARRA LATERAL --- */
    .petshop-tab-link {
        display: flex; align-items: center; padding: 1.2rem 2rem;
        font-size: 1.2rem; font-weight: 600; color: #555;
        text-decoration: none; transition: all 0.2s;
        border-left: 5px solid transparent;
    }
    .petshop-tab-link:hover { background-color: #fff; }
    .petshop-tab-link .material-symbols-outlined { margin-right: 15px; font-size: 1.8rem; }
    
    /* Estilos específicos para Marcas */
    .brands-menu-section { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee; }
    .brands-section-title { padding: 0 2rem; color: #999; font-size: 0.9rem; text-transform: uppercase; margin-bottom: 0.5rem; font-weight: 600; }
    .brand-link {
        display: block; font-size: 0.95rem; padding: 0.8rem 2rem;
        color: #777; text-decoration: none; border-left: 5px solid transparent;
        transition: all 0.2s;
    }
    .brand-link:hover { background-color: #f8f8f8; color: #555; }
    
    /* CLASE ACTIVA (SIRVE PARA TABS Y MARCAS) */
    .petshop-tab-link.active,
    .brand-link.active {
        background-color: #ffeaea !important; color: #E88989 !important;
        border-left-color: #E88989 !important; font-weight: 700 !important;
    }

    /* --- ESTILOS DE FILTROS --- */
    .filters-container {
        display: flex; flex-wrap: wrap; gap: 20px; background-color: white; 
        padding: 20px; border-radius: 12px; margin-bottom: 2rem;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    .filter-group { flex: 1; min-width: 200px; max-width: 400px; }
    .filter-group label { display: block; font-weight: 600; color: #555; margin-bottom: 5px; font-size: 0.9rem; }
    .filter-input, .filter-select { width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 0.95rem; }
    .filter-group-select { flex-grow: 1; flex-basis: 180px; max-width: 220px; }
    .filter-buttons { display: flex; gap: 10px; margin-left: auto; }
    .btn-filter { padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: background-color 0.3s; background-color: #ff8fab; color: white; border: none; font-size: 0.9rem; display: inline-flex; align-items: center; }
    .btn-filter:hover { background-color: #f87aa0; }
    .btn-clear-filter { padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: background-color 0.3s, color 0.3s; background-color: #f0f0f0; color: #555; border: 1px solid #ddd; text-decoration: none; font-size: 0.9rem; display: inline-flex; align-items: center; }
    .btn-clear-filter:hover { background-color: #e0e0e0; }

    /* --- ESTILOS DE PRODUCTOS --- */
    .page-title { text-align: center; font-size: 2.8rem; font-weight: bold; color: #ff8fab; margin-bottom: 2.5rem; }
    .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem; }
    .product-card { position: relative; border: 1px solid #eee; border-radius: 12px; overflow: hidden; background: white; box-shadow: 0 4px 12px rgba(0,0,0,0.05); transition: transform 0.3s; }
    .product-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
    .product-image { width: 100%; height: 200px; object-fit: cover; }
    .product-info { padding: 1rem; }
    .product-tags { margin-bottom: 0.5rem; height: 26px; overflow: hidden; }
    .tag { background-color: #f0f0f0; color: #555; padding: 3px 8px; border-radius: 5px; font-size: 0.75rem; margin-right: 5px; display: inline-block; }
    .product-name { font-weight: bold; font-size: 1.1rem; margin-bottom: 5px; height: 2.4em; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
    .product-price { font-size: 1.1rem; color: #E88989; font-weight: 600; }
    .btn-ver-mas { display: block; background-color: #97a992; color: white !important; text-align: center; padding: 0.6rem; text-decoration: none; margin-top: 1rem; border-radius: 8px; transition: background-color 0.3s; font-weight: 600; }
    .btn-ver-mas:hover { background-color: #82947c; }
    .favorito-btn { position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.9); backdrop-filter: blur(5px); border-radius: 50%; border: 1px solid #ddd; cursor: pointer; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
    .favorito-btn:hover { transform: scale(1.1); }
    .favorito-btn .material-symbols-outlined { color: #777; font-size: 1.4rem; font-variation-settings: 'FILL' 0; transition: all 0.2s; }
    .favorito-btn.active .material-symbols-outlined { font-variation-settings: 'FILL' 1; color: #E88989; }
</style>

<div class="petshop-category-page">
    
    <nav class="petshop-sidebar">
        <a class="petshop-tab-link" asp-controller="PetShop" asp-action="Index">
            <span class="material-symbols-outlined">arrow_back</span> Volver a Categorías
        </a>
        <a class="petshop-tab-link @(ViewData["TagActual"]?.ToString() == "Perro" ? "active" : "")" 
           asp-controller="PetShop" asp-action="Productos" asp-route-tag="Perro">
            <span class="material-symbols-outlined">pets</span> Perros
        </a>
        <a class="petshop-tab-link @(ViewData["TagActual"]?.ToString() == "Gato" ? "active" : "")" 
           asp-controller="PetShop" asp-action="Productos" asp-route-tag="Gato">
            <span class="material-symbols-outlined">pets</span> Gatos
        </a>

        <div class="brands-menu-section">
            <div class="brands-section-title">Tiendas</div>
            <a class="brand-link @(string.Equals(marcaActual, "Petco", StringComparison.OrdinalIgnoreCase) ? "active" : "")"
               asp-controller="PetShop" asp-action="Productos" asp-route-marca="Petco">Petco</a>
            <a class="brand-link @(string.Equals(marcaActual, "PetSmart", StringComparison.OrdinalIgnoreCase) ? "active" : "")"
               asp-controller="PetShop" asp-action="Productos" asp-route-marca="PetSmart">PetSmart</a>
            <a class="brand-link @(string.Equals(marcaActual, "Chewy", StringComparison.OrdinalIgnoreCase) ? "active" : "")"
               asp-controller="PetShop" asp-action="Productos" asp-route-marca="Chewy">Chewy</a>
            <a class="brand-link @(string.Equals(marcaActual, "Amazon Pets", StringComparison.OrdinalIgnoreCase) ? "active" : "")"
               asp-controller="PetShop" asp-action="Productos" asp-route-marca="Amazon Pets">Amazon</a>

            <div class="brands-section-title" style="margin-top: 1.5rem;">Destacadas</div>
            <a class="brand-link @(string.Equals(marcaActual, "Royal Canin", StringComparison.OrdinalIgnoreCase) ? "active" : "")"
               asp-controller="PetShop" asp-action="Productos" asp-route-marca="Royal Canin">Royal Canin</a>
            <a class="brand-link @(string.Equals(marcaActual, "Purina", StringComparison.OrdinalIgnoreCase) ? "active" : "")"
               asp-controller="PetShop" asp-action="Productos" asp-route-marca="Purina">Purina</a>
            <a class="brand-link @(string.Equals(marcaActual, "Hills", StringComparison.OrdinalIgnoreCase) ? "active" : "")"
               asp-controller="PetShop" asp-action="Productos" asp-route-marca="Hills">Hill's</a>
        </div>
    </nav>

    <div class="petshop-main-content">

        <h1 class="page-title">Pet Shop</h1>

        @if (ViewData["Title"]?.ToString()?.StartsWith("Marca:") == true)
        {
            <h2 style="text-align: center; color: #555; margin-bottom: 2rem; font-size: 1.5rem;">
                Viendo productos de: <span style="color: #E88989; font-weight: bold;">@ViewData["Title"].ToString().Replace("Marca: ", "")</span>
            </h2>
        }
    
        @if (string.IsNullOrEmpty(marcaActual))
        {
            <form asp-action="Productos" method="get" class="filters-container">
                <div class="filter-group">
                    <label for="busqueda">Buscar</label>
                    <input type="text" id="busqueda" name="busqueda" class="filter-input" placeholder="Ej: pelota..." value="@busquedaActual" />
                </div>
                <div class="filter-group filter-group-select">
                    <label for="tipo">Tipo</label>
                    <select id="tipo" name="tipo" class="filter-select">
                        <option value="Todos" selected="@(tipoActual == "Todos")">Todos</option>
                        @foreach (var tipo in tiposProducto) {
                            <option value="@tipo" selected="@(tipoActual == tipo)">@tipo</option>
                        }
                    </select>
                </div>
                <div class="filter-buttons">
                    <button type="submit" class="btn-filter">Buscar</button>
                    <a asp-controller="PetShop" asp-action="Productos" class="btn-clear-filter">Borrar</a>
                </div>
            </form>
        }

        <div class="product-grid">
            @if (!Model.Any())
            {
                <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: #999;">
                    <span class="material-symbols-outlined" style="font-size: 4rem; margin-bottom: 1rem;">search_off</span>
                    <p style="font-size: 1.2rem;">No se encontraron productos.</p>
                </div>
            }
            else
            {
                @foreach (var item in Model)
                {
                    <div class="product-card">
                        <img src="@item.UrlImagen" alt="@item.Nombre" class="product-image" onerror="this.onerror=null;this.src='/images/placeholder.png';" />
                        
                        @if (item.EsExterno)
                        {
                            /* --- PRODUCTO DE GOOGLE (SIN FAVORITO, ENLACE EXTERNO) --- */
                             <div class="product-info">
                                <div class="product-name" style="-webkit-line-clamp: 3;">@item.Nombre</div>
                                <p style="color: #999; font-size: 0.85rem; margin-bottom: 1rem;">Vendido por: <strong>@item.NombreTienda</strong></p>
                                <a asp-action="DetalleExterno" 
                                   asp-route-nombre="@item.Nombre"
                                   asp-route-imagen="@item.UrlImagen"
                                   asp-route-descripcion="@item.Descripcion"
                                   asp-route-url="@item.UrlExterna"
                                   asp-route-tienda="@item.NombreTienda"
                                   class="btn-ver-mas" style="display: flex; align-items: center; justify-content: center; gap: 5px;">
                                    Ver Detalles <span class="material-symbols-outlined" style="font-size: 1rem;">visibility</span>
                                </a>
                            </div>
                        }
                        else
                        {
                            /* --- PRODUCTO LOCAL (CON FAVORITO, ENLACE INTERNO) --- */
                            <button class="favorito-btn @(item.EsFavorito ? "active" : "")" data-id="@item.Id">
                                <span class="material-symbols-outlined">favorite</span>
                            </button>
                            <div class="product-info">
                                <div class="product-tags">
                                    @foreach(var tag in item.Tags.Take(2)) { <span class="tag">@tag</span> }
                                </div>
                                <div class="product-name">@item.Nombre</div>
                                <div class="product-price">S/. @item.Precio.ToString("0.00")</div>
                                <a asp-action="Detalle" asp-route-id="@item.Id" class="btn-ver-mas">Ver más</a>
                            </div>
                        }
                    </div>
                }
            }
        </div>

    </div> </div> <div id="modal-alerta-favoritos" class="modal-alerta" style="display:none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center;">
     <div style="background: white; padding: 2rem; border-radius: 12px; text-align: center; max-width: 90%;">
         <span class="material-symbols-outlined" style="font-size: 3rem; color: #E88989; margin-bottom: 1rem;">lock</span>
         <h3>Acceso Requerido</h3>
         <p>Debes iniciar sesión para guardar tus productos favoritos.</p>
         <div style="margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: center;">
             <a href="/Identity/Account/Login" class="btn btn-primary">Iniciar Sesión</a>
             <button onclick="document.getElementById('modal-alerta-favoritos').style.display='none'" class="btn btn-outline-secondary">Cerrar</button>
         </div>
     </div>
</div>

@Html.AntiForgeryToken()

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const modalAlerta = document.getElementById('modal-alerta-favoritos');
            // Pasamos el estado de login de forma segura
            const isUserLoggedIn = @(SignInManager.IsSignedIn(User) ? "true" : "false");
            
            document.querySelectorAll('.favorito-btn').forEach(button => {
                button.addEventListener('click', async function(event) {
                    event.preventDefault(); // Prevenir comportamiento por defecto
                    
                    if (!isUserLoggedIn) {
                        modalAlerta.style.display = 'flex'; // Mostrar modal personalizado
                        return;
                    }

                    const btn = this; // Referencia al botón clicado
                    // Animación de pulsación inmediata para feedback
                    btn.style.transform = "scale(0.8)";
                    setTimeout(() => btn.style.transform = "scale(1)", 150);

                    const productoId = btn.dataset.id;
                    const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

                    try {
                        const response = await fetch('/PetShop/ToggleFavorito', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                                'RequestVerificationToken': token
                            },
                            body: `productoId=${productoId}`
                        });

                        if (response.ok) {
                            const result = await response.json();
                            if (result.success) {
                                btn.classList.toggle('active', result.agregado);
                            }
                        }
                    } catch (error) { console.error('Error en favoritos:', error); }
                });
            });

            // Cerrar modal al hacer clic fuera
            window.addEventListener('click', (e) => {
                if (e.target === modalAlerta) modalAlerta.style.display = 'none';
            });
        });
    </script>
}